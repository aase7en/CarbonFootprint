<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Carbon Footprint รพ.อุทัย</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Charts for data visualization -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <!-- Google Fonts for Thai typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to integrate with Tailwind */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f8fafc; /* Tailwind's gray-50 */
        }
        /* Custom styles for Google Charts to match the theme */
        .google-visualization-tooltip {
            font-family: 'Sarabun', sans-serif !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
            border: 1px solid #e2e8f0 !important;
        }
        /* Style for table sort indicators */
        .sort-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 8px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        th:hover .sort-indicator {
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-green-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-600">กำลังโหลดข้อมูลแดชบอร์ด...</p>
        </div>
    </div>

    <div id="content" class="dashboard-container max-w-7xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <div class="flex items-center gap-3">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard Carbon Footprint</h1>
            </div>
            <a href="https://aase7en.github.io/CarbonFootprint/" class="mt-4 md:mt-0 w-full md:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors" target="_top">
            กลับหน้าบันทึกข้อมูล
            </a>
            <!-- <a href="<?= ScriptApp.getService().getUrl(); ?>" class="mt-4 md:mt-0 w-full md:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                กลับหน้าบันทึกข้อมูล
            </a> -->
        </header>

        <!-- Filters Section -->
        <section class="mb-6 p-4 bg-white rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4 text-gray-700">ตัวกรองข้อมูล</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="filter-group">
                    <label for="startDate" class="block text-sm font-medium text-gray-700">วันที่เริ่มต้น</label>
                    <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                </div>
                <div class="filter-group">
                    <label for="endDate" class="block text-sm font-medium text-gray-700">วันที่สิ้นสุด</label>
                    <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                </div>
                <div class="filter-group">
                    <label for="departmentFilter" class="block text-sm font-medium text-gray-700">แผนก</label>
                    <select id="departmentFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                        <option value="">ทุกแผนก</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="activityFilter" class="block text-sm font-medium text-gray-700">กิจกรรม</label>
                    <select id="activityFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                        <option value="">ทุกกิจกรรม</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Summary Cards Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="summary-card bg-white p-6 rounded-lg shadow flex items-center gap-4 border-l-4 border-blue-500">
                <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">จำนวนรายการทั้งหมด</h4>
                    <p id="total-records" class="text-3xl font-bold text-gray-800">0</p>
                </div>
            </div>
            <div class="summary-card bg-white p-6 rounded-lg shadow flex items-center gap-4 border-l-4 border-green-500">
                 <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0117.657 18.657z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1014.12 11.88l-4.242 4.242z" /></svg></div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">ปริมาณการปล่อยรวม</h4>
                    <p id="total-emission" class="text-3xl font-bold text-gray-800">0</p>
                    <span class="text-sm text-gray-500">kgCO₂e</span>
                </div>
            </div>
        </section>

        <!-- Main Content: Chart and Table -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Chart -->
            <section class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                 <div id="chart_div" class="w-full h-96"></div>
            </section>
            
            <!-- Table -->
            <section class="lg:col-span-3 bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-green-800 text-white">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('dataDate', this)">วันที่ข้อมูล <span class="sort-indicator"></span></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('department', this)">แผนก <span class="sort-indicator"></span></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('activity', this)">กิจกรรม <span class="sort-indicator"></span></th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('value', this)">ปริมาณ <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                           <!-- Data rows will be inserted here by JavaScript -->
                        </tbody>
                         <tfoot class="bg-gray-100">
                            <tr>
                                <td colspan="3" class="px-6 py-4 text-right font-semibold text-gray-700">ผลรวมย่อย (Subtotal):</td>
                                <td id="subtotal-value" class="px-6 py-4 font-bold text-gray-800">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        let allData = [];
        let sortState = { key: 'dataDate', direction: 'desc' };

        const emissionFactors = {
            "การใช้ไฟฟ้า": 0.5821, // kgCO2e per kWh
            "การใช้น้ำประปาส่วนภูมิภาค": 0.0264, // kgCO2e per m3
            "การใช้กระดาษ A4": 1.8375, // kgCO2e per ream (assuming 1 ream = 2.5kg, 0.735 kgCO2e/kg)
            "ขยะติดเชื้อ": 0.8421, // kgCO2e per kg
            "ขยะทั่วไป": 0.8421, // kgCO2e per kg (landfill)
            "ขยะอินทรีย์": 0.8421, // kgCO2e per kg (landfill)
            "การใช้น้ำมันดีเซลกับยานพาหนะ": 2.7446, // kgCO2e per L
            "การใช้น้ำมันดีเซลกับเครื่องจักร": 2.7446, // kgCO2e per L
            "การใช้น้ำมันเบนซินกับยานพาหนะ": 2.3, // kgCO2e per L
            "การใช้น้ำมันเบนซินกับเครื่องจักร": 2.3, // kgCO2e per L
            "การใช้ก๊าซหุงต้ม": 2.983, // kgCO2e per kg
        };

        document.addEventListener("DOMContentLoaded", () => {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(initializeDashboard);
        });
        
        function initializeDashboard() {
            ['startDate', 'endDate', 'departmentFilter', 'activityFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFiltersAndRender);
            });
            
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run.withSuccessHandler(dataLoaded).getSheetData();
            } else {
                console.log("Running in PREVIEW mode. Using mock data.");
                const mockData = [
                    ["2025-08-27T12:00:00.000Z", "2025-08-26", "กลุ่มการพยาบาล", "การใช้ไฟฟ้า", 2500, "kWh"],
                    ["2025-08-27T12:01:00.000Z", "2025-08-26", "กลุ่มงานเภสัชกรรม", "การใช้กระดาษ A4", 15, "รีม"],
                    ["2025-08-27T12:02:00.000Z", "2025-08-25", "งานโภชนาการ", "ขยะอินทรีย์", 120, "กิโลกรัม"],
                    ["2025-08-28T10:00:00.000Z", "2025-08-27", "งานยานพาหนะ", "การใช้น้ำมันดีเซลกับยานพาหนะ", 55, "ลิตร"],
                    ["2025-08-28T11:00:00.000Z", "2025-08-27", "กลุ่มงานทันตกรรม", "ขยะติดเชื้อ", 25, "กิโลกรัม"],
                ];
                setTimeout(() => dataLoaded(mockData), 500);
            }
        }

        function dataLoaded(dataFromServer) {
            if (dataFromServer.error) {
                console.error("Error fetching sheet data:", dataFromServer.message);
                document.getElementById('loading').innerHTML = `<p class="text-red-600 font-semibold">เกิดข้อผิดพลาด: ${dataFromServer.message}</p>`;
                return;
            }

            allData = dataFromServer.map(row => {
                const dateParts = row[1].split('-');
                const activity = row[3];
                const value = parseFloat(row[4]) || 0;
                const co2e = value * (emissionFactors[activity] || 0);
                return {
                    dataDate: new Date(dateParts[0], dateParts[1] - 1, dateParts[2]),
                    department: row[2],
                    activity: activity,
                    value: value,
                    unit: row[5],
                    co2e: co2e
                };
            }).filter(item => item.department && item.activity);
            
            populateFilters();
            applyFiltersAndRender();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').classList.remove('hidden');
        }

        function populateFilters() {
            const departments = [...new Set(allData.map(item => item.department))].sort((a,b) => a.localeCompare(b, 'th'));
            const activities = [...new Set(allData.map(item => item.activity))].sort((a,b) => a.localeCompare(b, 'th'));
            
            const deptFilter = document.getElementById('departmentFilter');
            departments.forEach(dept => deptFilter.add(new Option(dept, dept)));

            const activityFilter = document.getElementById('activityFilter');
            activities.forEach(activity => activityFilter.add(new Option(activity, activity)));
        }

        function applyFiltersAndRender() {
            const startDate = document.getElementById('startDate').valueAsDate;
            let endDate = document.getElementById('endDate').valueAsDate; // << เปลี่ยนจาก const เป็น let
            const department = document.getElementById('departmentFilter').value;
            const activity = document.getElementById('activityFilter').value;

            // --- ✨ โค้ดที่เพิ่มเข้ามา ---
            // ถ้่ามีการเลือกวันที่สิ้นสุด ให้ตั้งเวลาไปที่ท้ายสุดของวัน (23:59:59)
            // เพื่อให้แน่ใจว่าข้อมูลทั้งหมดของวันนั้นจะถูกรวมเข้ามาด้วย
            if (endDate) {
                endDate.setHours(23, 59, 59, 999);
            }
            // --------------------------

            const filteredData = allData.filter(item => {
                const itemDate = item.dataDate; // ไม่ต้องสร้าง Date ใหม่ เพราะเป็น Date object อยู่แล้ว
                
                const isAfterStartDate = !startDate || itemDate >= startDate;
                const isBeforeEndDate = !endDate || itemDate <= endDate;
                const isDeptMatch = !department || item.department === department;
                const isActivityMatch = !activity || item.activity === activity;
                return isAfterStartDate && isBeforeEndDate && isDeptMatch && isActivityMatch;
            });

            renderAll(filteredData);
        }
        
        function renderAll(data) {
            renderSummary(data);
            sortAndRenderTable(data);
            renderChart(data);
        }
        
        function renderSummary(data) {
            const totalRecords = data.length;
            const totalEmission = data.reduce((sum, item) => sum + item.co2e, 0);

            document.getElementById('total-records').textContent = totalRecords.toLocaleString('th-TH');
            document.getElementById('total-emission').textContent = totalEmission.toLocaleString('th-TH', { maximumFractionDigits: 2 });
        }

        function renderTable(data) {
            const tableBody = document.getElementById('dataTableBody');
            let subtotal = 0;
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 py-8">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</td></tr>`;
                document.getElementById('subtotal-value').textContent = '0';
                return;
            }
            tableBody.innerHTML = data.map(item => {
                const formattedDate = item.dataDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                subtotal += item.value;
                return `<tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${item.department}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.activity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">${item.value.toLocaleString('th-TH')} ${item.unit}</td>
                </tr>`;
            }).join('');
            document.getElementById('subtotal-value').textContent = subtotal.toLocaleString('th-TH');
        }
        
        function sortTableByColumn(key, thElement) {
            if (sortState.key === key) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = key;
                sortState.direction = 'asc';
            }
            applyFiltersAndRender(); // Re-filter and re-render to apply sort
        }

        function sortAndRenderTable(data) {
            const sortedData = [...data].sort((a, b) => {
                const valA = a[sortState.key];
                const valB = b[sortState.key];
                
                let comparison = 0;
                if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }
                
                return sortState.direction === 'asc' ? comparison : -comparison;
            });
            
            updateSortIndicators();
            renderTable(sortedData);
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('th .sort-indicator').forEach(span => span.innerHTML = '');
            const th = document.querySelector(`th[onclick="sortTableByColumn('${sortState.key}', this)"]`);
            if (th) {
                th.querySelector('.sort-indicator').innerHTML = sortState.direction === 'asc' ? '▲' : '▼';
            }
        }

        function renderChart(data) {
            const aggregatedData = data.reduce((acc, item) => {
                const { activity, co2e } = item;
                acc[activity] = (acc[activity] || 0) + co2e;
                return acc;
            }, {});

            const sortedActivities = Object.entries(aggregatedData).sort((a, b) => b[1] - a[1]);

            if (sortedActivities.length === 0) {
                 document.getElementById('chart_div').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">ไม่มีข้อมูลสำหรับแสดงกราฟ</div>';
                 return;
            }

            const chartData = [['กิจกรรม', 'kgCO₂e', { role: 'style' }, { role: 'tooltip', type: 'string', p: { html: true } }]];
            const colors = ['#28a745', '#20c997', '#17a2b8', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1', '#6610f2', '#e83e8c'];
            let colorIndex = 0;
            
            sortedActivities.forEach(([activity, val]) => {
                const color = colors[colorIndex % colors.length];
                const tooltip = `<div class="p-2 text-sm font-sans">
                                   <div class="font-bold">${activity}</div>
                                   <div>ปล่อย: <span class="font-bold">${val.toLocaleString('th-TH', {maximumFractionDigits: 2})}</span> kgCO₂e</div>
                                 </div>`;
                chartData.push([activity, val, color, tooltip]);
                colorIndex++;
            });

            const dataTable = google.visualization.arrayToDataTable(chartData);
            const options = {
                title: 'สรุปการปล่อยก๊าซเรือนกระจกรายกิจกรรม',
                titleTextStyle: { color: '#334155', fontName: 'Sarabun', fontSize: 18, bold: true },
                chartArea: {width: '65%', height: '80%'},
                hAxis: { 
                    title: 'ปริมาณการปล่อย (kgCO₂e)', 
                    minValue: 0, 
                    format: 'short',
                    titleTextStyle: { color: '#475569', fontName: 'Sarabun' },
                    textStyle: { color: '#64748b', fontName: 'Sarabun' }
                },
                vAxis: { 
                    textStyle: { color: '#475569', fontName: 'Sarabun', fontSize: 12 }
                },
                legend: { position: 'none' },
                tooltip: { isHtml: true },
                bar: { groupWidth: '75%' },
                animation: {
                    startup: true,
                    duration: 1000,
                    easing: 'out',
                },
            };

            const chart = new google.visualization.BarChart(document.getElementById('chart_div'));
            chart.draw(dataTable, options);
        }
    </script>
</body>
</html>
