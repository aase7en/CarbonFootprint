<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Carbon Footprint | รพ.อุทัย</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --primary-green: #005A31;
        --secondary-green: #4CAF50;
        --primary-blue: #007bff;
        --light-gray: #f8fafc;
        --text-dark: #334155;
        --border-color: #e5e7eb;
      }
      body {
        font-family: 'Sarabun', sans-serif;
        background-color: var(--light-gray);
        color: var(--text-dark);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      .g-chart-tooltip {
        font-family: 'Sarabun', sans-serif !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        border: none !important;
        background-color: white !important;
        padding: 12px !important;
      }
      .date-preset-btn.active {
        background-color: var(--primary-green) !important;
        color: white !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      /* Toast Notification */
      #toast {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 8px;
        background-color: var(--primary-green);
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: bottom 0.5s ease-in-out;
        z-index: 9999;
        font-weight: 500;
      }
      #toast.show {
        bottom: 30px;
      }
    </style>
</head>
<body>

    <div id="loading" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-green-700 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-gray-600">กำลังโหลดข้อมูลแดชบอร์ด...</p>
        </div>
    </div>

    <div id="content" class="max-w-screen-xl mx-auto p-4 md:p-6 lg:p-8 hidden">
        
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200 gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-green-100 p-2 rounded-lg">
                    <svg class="w-8 h-8 text-green-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"></path></svg>
                </div>
                <div>
                  <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Dashboard Carbon Footprint</h1>
                  <p class="text-gray-500">โรงพยาบาลอุทัย</p>
                </div>
            </div>
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <button onclick="refreshData()" class="flex items-center justify-center w-full sm:w-auto gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M20 4l-4 4M4 20l4-4M15 4h5v5M4 9V4h5" /></svg>
                    รีเฟรช
                </button>
                <a href="https://aase7en.github.io/CarbonFootprint/" target="_top" class="flex items-center justify-center w-full sm:w-auto gap-2 px-4 py-2 text-sm font-medium text-white bg-green-700 border border-transparent rounded-lg shadow-sm hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 transition-all">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    บันทึกข้อมูล
                </a>
            </div>
        </header>
        
        <section class="mb-6 p-5 bg-white rounded-xl shadow-md">
            <h2 class="text-lg font-semibold mb-4 text-gray-700 flex items-center gap-2">
              <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" /></svg>
              ตัวกรองข้อมูล
            </h2>
            <div class="space-y-4">
                <div class="flex flex-wrap items-center gap-2">
                    <button class="date-preset-btn px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" onclick="setDateRangePreset(0)">วันนี้</button>
                    <button class="date-preset-btn px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" onclick="setDateRangePreset(7)">7 วัน</button>
                    <button class="date-preset-btn px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-full transition-colors active" onclick="setDateRangePreset(30)">30 วัน</button>
                    <button class="date-preset-btn px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" onclick="setDateRangePreset(90)">90 วัน</button>
                    <button class="date-preset-btn px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-full transition-colors" onclick="setDateRangePreset(365)">1 ปี</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <input type="date" id="startDate" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                    <input type="date" id="endDate" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                    <select id="departmentFilter" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="">ทุกแผนก</option></select>
                    <select id="activityFilter" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"><option value="">ทุกกิจกรรม</option></select>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500"><h4 class="text-sm font-medium text-gray-500">จำนวนรายการทั้งหมด</h4><p id="total-records" class="text-3xl font-bold text-gray-800">0</p></div>
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500"><h4 class="text-sm font-medium text-gray-500">ปริมาณการปล่อยรวม</h4><p id="total-emission" class="text-3xl font-bold text-gray-800">0</p><span class="text-sm text-gray-500">kgCO₂e</span></div>
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-yellow-500"><h4 class="text-sm font-medium text-gray-500">เฉลี่ยต่อวัน</h4><p id="average-emission" class="text-3xl font-bold text-gray-800">0</p><span class="text-sm text-gray-500">kgCO₂e</span></div>
            <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-purple-500"><h4 class="text-sm font-medium text-gray-500">แผนกที่ปล่อยสูงสุด</h4><p id="top-department" class="text-xl font-bold text-gray-800">-</p></div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
            <div class="lg:col-span-3 bg-white p-5 rounded-xl shadow-md"><div id="trend_chart_div" class="w-full h-96"></div></div>
            <div class="lg:col-span-2 bg-white p-5 rounded-xl shadow-md"><div id="activity_chart_div" class="w-full h-96"></div></div>
        </section>
        
        <section class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700">ข้อมูล Carbon Footprint</h2>
                <button onclick="exportToCSV()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-green-700 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all">
                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                  ส่งออก CSV
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('dataDate', this)">วันที่ข้อมูล <span class="sort-indicator"></span></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('department', this)">แผนก <span class="sort-indicator"></span></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('activity', this)">กิจกรรม <span class="sort-indicator"></span></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('value', this)">ปริมาณ <span class="sort-indicator"></span></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onclick="sortTableByColumn('co2e', this)">CO₂e (kg) <span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </section>

    </div>
    
    <div id="toast"></div>

    <script>
    let allData = [];
    let filteredData = [];
    let sortState = { key: 'dataDate', direction: 'desc' };

    const emissionFactors = {
        "การใช้ไฟฟ้า": 0.4984,
        "การใช้น้ำประปาส่วนภูมิภาค": 0.0003,
        "ใช้น้ำประปาส่วนภูมิภาค": 0.0003, // ชื่อเก่า
        "ขยะติดเชื้อ": 0.45,
        "ขยะทั่วไป": 0.584,
        "ขยะอินทรีย์": 0.584,
        "การใช้ก๊าซหุงต้ม": 3.0337,
        "การใช้น้ำมันดีเซลกับยานพาหนะ": 2.6938,
        "ปริมาณดีเซล - ยานพาหนะ": 2.6938, // ชื่อเก่า
        "การใช้น้ำมันเบนซินกับยานพาหนะ": 2.2968,
        "ปริมาณเบนซิน - ยานพาหนะ": 2.2968, // ชื่อเก่า
        "การใช้น้ำมันดีเซลกับเครื่องจักร": 2.6938,
        "ปริมาณดีเซล - เครื่องจักร": 2.6938, // ชื่อเก่า
        "การใช้น้ำมันเบนซินกับเครื่องจักร": 2.2968,
        "ปริมาณเบนซิน - เครื่องจักร": 2.2968, // ชื่อเก่า
        "การใช้กระดาษ A4": 1.8375,
        "ปริมาณการใช้กระดาษ A4": 1.8375, // ชื่อเก่า
        "การใช้กระดาษ A5": 0.9187, // ครึ่งหนึ่งของ A4
        "ปริมาณการใช้กระดาษ A5": 0.9187, // ชื่อเก่า
        "การใช้สารเคมี คลอรีน": 1.4,
        "การใช้สารเคมี-คลอรีน": 1.4, // ชื่อเก่า
        "การใช้หมึกพิมพ์": 3.0,
        "การใช้หมึก": 3.0, // ชื่อเก่า
    };

    // Map สำหรับแปลงชื่อกิจกรรมเก่าให้เป็นชื่อมาตรฐาน เพื่อการแสดงผลที่สวยงาม
    const activityNameMap = {
        "ใช้น้ำประปาส่วนภูมิภาค": "การใช้น้ำประปาส่วนภูมิภาค",
        "ปริมาณดีเซล - ยานพาหนะ": "การใช้น้ำมันดีเซลกับยานพาหนะ",
        "ปริมาณเบนซิน - ยานพาหนะ": "การใช้น้ำมันเบนซินกับยานพาหนะ",
        "ปริมาณดีเซล - เครื่องจักร": "การใช้น้ำมันดีเซลกับเครื่องจักร",
        "ปริมาณเบนซิน - เครื่องจักร": "การใช้น้ำมันเบนซินกับเครื่องจักร",
        "ปริมาณการใช้กระดาษ A4": "การใช้กระดาษ A4",
        "ปริมาณการใช้กระดาษ A5": "การใช้กระดาษ A5",
        "การใช้สารเคมี-คลอรีน": "การใช้สารเคมี คลอรีน",
        "การใช้หมึก": "การใช้หมึกพิมพ์"
    };
    // -------------------------

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(fetchData);
    });
    
    function fetchData() {
        document.getElementById('loading').style.display = 'flex';
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run.withSuccessHandler(dataLoaded).getSheetData();
        } else {
            console.warn("Running in PREVIEW mode. Using mock data.");
            const mockData = [
                ["2025-09-22T12:00:00.000Z", "2025-09-22", "กลุ่มงานบริหารทั่วไป", "ปริมาณการใช้กระดาษ A4", 44, "รีม"],
                ["2025-09-21T12:00:00.000Z", "2025-09-21", "งานซ่อมบำรุง", "ปริมาณเบนซิน - เครื่องจักร", 21, "ลิตร"],
                ["2025-09-20T12:00:00.000Z", "2025-09-20", "กลุ่มการพยาบาล", "การใช้ไฟฟ้า", 60105, "kWh"],
                ["2025-09-19T12:00:00.000Z", "2025-09-19", "กลุ่มงานผู้ป่วยนอก", "การใช้น้ำประปาส่วนภูมิภาค", 89, "ลูกบาศก์เมตร"],
                ["2025-09-18T12:00:00.000Z", "2025-09-18", "กลุ่มงานเภสัชกรรม", "การใช้สารเคมี คลอรีน", 8.5, "ลิตร"]
            ];
            setTimeout(() => dataLoaded(mockData), 800);
        }
    }

    function dataLoaded(dataFromServer) {
        if (dataFromServer.error) {
            document.getElementById('loading').innerHTML = `<p class="text-red-600 font-semibold">เกิดข้อผิดพลาด: ${dataFromServer.message}</p>`;
            return;
        }

        allData = dataFromServer.map(row => {
            const originalActivity = row[3] ? String(row[3]).trim() : '';
            const value = parseFloat(row[4]) || 0;
            const co2e = value * (emissionFactors[originalActivity] || 0);
            const standardizedActivity = activityNameMap[originalActivity] || originalActivity;

            return {
                dataDate: new Date(row[1]),
                department: row[2],
                activity: standardizedActivity,
                value: value,
                unit: row[5],
                co2e: co2e
            };
        }).filter(item => item.department && item.activity);
        
        initializeDashboard();
    }

    function initializeDashboard() {
        populateFilters();
        setupEventListeners();
        setDateRangePreset(30);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').classList.remove('hidden');
    }

    function populateFilters() {
        const departments = [...new Set(allData.map(item => item.department))].sort((a,b) => a.localeCompare(b, 'th'));
        const activities = [...new Set(allData.map(item => item.activity))].sort((a,b) => a.localeCompare(b, 'th'));
        
        const deptFilter = document.getElementById('departmentFilter');
        deptFilter.innerHTML = '<option value="">ทุกแผนก</option>';
        departments.forEach(dept => deptFilter.add(new Option(dept, dept)));
        
        const activityFilter = document.getElementById('activityFilter');
        activityFilter.innerHTML = '<option value="">ทุกกิจกรรม</option>';
        activities.forEach(activity => activityFilter.add(new Option(activity, activity)));
    }

    function setupEventListeners() {
         ['startDate', 'endDate', 'departmentFilter', 'activityFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                document.querySelectorAll('.date-preset-btn').forEach(btn => btn.classList.remove('active'));
                applyFiltersAndRender();
            });
        });
    }

    function setDateRangePreset(days) {
        const today = new Date();
        today.setHours(23, 59, 59, 999);
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - (days - 1));
        startDate.setHours(0, 0, 0, 0);

        if(days === 0) {
          startDate.setDate(today.getDate());
        }

        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        
        document.querySelectorAll('.date-preset-btn').forEach((btn, index) => {
            const presetDays = [0, 7, 30, 90, 365];
            if(presetDays[index] === days) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        applyFiltersAndRender();
    }

    function applyFiltersAndRender() {
        const startDate = document.getElementById('startDate').valueAsDate;
        const endDate = document.getElementById('endDate').valueAsDate;
        if (endDate) endDate.setHours(23, 59, 59, 999);
        
        const department = document.getElementById('departmentFilter').value;
        const activity = document.getElementById('activityFilter').value;

        filteredData = allData.filter(item => {
            return (!startDate || item.dataDate >= startDate) &&
                   (!endDate || item.dataDate <= endDate) &&
                   (!department || item.department === department) &&
                   (!activity || item.activity === activity);
        });
        renderAll(filteredData);
    }
    
    function renderAll(data) {
        renderSummaryCards(data);
        renderTable(data);
        renderTrendChart(data);
        renderActivityChart(data);
    }
    
    function renderSummaryCards(data) {
        const totalRecords = data.length;
        const totalEmission = data.reduce((sum, item) => sum + item.co2e, 0);
        
        const dateRange = new Set(data.map(d => d.dataDate.toISOString().split('T')[0]));
        const days = dateRange.size || 1;
        const averageEmission = totalEmission / days;
        
        const deptEmissions = data.reduce((acc, item) => {
            acc[item.department] = (acc[item.department] || 0) + item.co2e;
            return acc;
        }, {});
        const topDepartment = Object.entries(deptEmissions).sort((a,b) => b[1] - a[1])[0];

        document.getElementById('total-records').textContent = totalRecords.toLocaleString('th-TH');
        document.getElementById('total-emission').textContent = totalEmission.toLocaleString('th-TH', { maximumFractionDigits: 2 });
        document.getElementById('average-emission').textContent = averageEmission.toLocaleString('th-TH', { maximumFractionDigits: 2 });
        document.getElementById('top-department').textContent = topDepartment ? topDepartment[0] : '-';
    }
    
    function renderTable(data) {
        const sortedData = [...data].sort((a, b) => {
            const valA = a[sortState.key];
            const valB = b[sortState.key];
            let comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;
            return sortState.direction === 'asc' ? comparison : -comparison;
        });
        updateSortIndicators();

        const tableBody = document.getElementById('dataTableBody');
        if (sortedData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 py-10">ไม่พบข้อมูล</td></tr>`;
            return;
        }
        tableBody.innerHTML = sortedData.map(item => `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 text-sm text-gray-600">${item.dataDate.toLocaleDateString('th-TH', { year: '2-digit', month: 'short', day: 'numeric' })}</td>
                <td class="px-6 py-4 text-sm text-gray-800 font-medium">${item.department}</td>
                <td class="px-6 py-4 text-sm text-gray-600">${item.activity}</td>
                <td class="px-6 py-4 text-sm text-gray-800">${item.value.toLocaleString('th-TH')} ${item.unit}</td>
                <td class="px-6 py-4 text-sm text-gray-800 font-bold">${item.co2e.toFixed(4)}</td>
            </tr>`).join('');
    }

    function renderTrendChart(data) {
        const aggregated = data.reduce((acc, item) => {
            const dateKey = item.dataDate.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' });
            acc[dateKey] = (acc[dateKey] || 0) + item.co2e;
            return acc;
        }, {});
        
        const chartData = [['วันที่', 'kgCO₂e']].concat(Object.entries(aggregated));

        if (chartData.length <= 1) {
            document.getElementById('trend_chart_div').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">ข้อมูลไม่เพียงพอสำหรับแสดงกราฟแนวโน้ม</div>';
            return;
        }

        const dataTable = google.visualization.arrayToDataTable(chartData);
        const options = {
            title: 'แนวโน้มการปล่อย CO₂e',
            titleTextStyle: { color: '#334155', fontName: 'Sarabun', fontSize: 16, bold: false },
            chartArea: {width: '85%', height: '75%'},
            hAxis: { textStyle: { color: '#64748b', fontName: 'Sarabun', fontSize: 11 } },
            vAxis: { title: 'kgCO₂e', format: 'short', textStyle: { color: '#64748b', fontName: 'Sarabun' } },
            legend: { position: 'none' },
            tooltip: { trigger: 'focus', textStyle: { fontName: 'Sarabun' } },
            colors: [getComputedStyle(document.documentElement).getPropertyValue('--primary-green')],
            animation: { startup: true, duration: 1000, easing: 'out' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById('trend_chart_div'));
        chart.draw(dataTable, options);
    }

    function renderActivityChart(data) {
        const aggregated = data.reduce((acc, item) => {
            if (item.co2e > 0) {
              acc[item.activity] = (acc[item.activity] || 0) + item.co2e;
            }
            return acc;
        }, {});

        const sorted = Object.entries(aggregated).sort((a,b) => b[1] - a[1]);
        const chartData = [['กิจกรรม', 'kgCO₂e']].concat(sorted);
        
        if (chartData.length <= 1) {
            document.getElementById('activity_chart_div').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">ไม่มีข้อมูลสำหรับแสดงกราฟสัดส่วน</div>';
            return;
        }

        const dataTable = google.visualization.arrayToDataTable(chartData);
        const options = {
            title: 'สัดส่วนการปล่อย CO₂e ตามกิจกรรม',
            titleTextStyle: { color: '#334155', fontName: 'Sarabun', fontSize: 16, bold: false },
            pieHole: 0.4,
            chartArea: {width: '90%', height: '80%'},
            legend: { position: 'bottom', textStyle: { color: '#475569', fontName: 'Sarabun' } },
            tooltip: { textStyle: { fontName: 'Sarabun' } },
            pieSliceTextStyle: { color: 'black' },
            animation: { startup: true, duration: 1000, easing: 'out' }
        };
        const chart = new google.visualization.PieChart(document.getElementById('activity_chart_div'));
        chart.draw(dataTable, options);
    }
    
    function sortTableByColumn(key, thElement) {
        sortState.key === key ? sortState.direction = (sortState.direction === 'asc' ? 'desc' : 'asc') : (sortState.key = key, sortState.direction = 'asc');
        renderTable(filteredData);
    }

    function updateSortIndicators() {
        document.querySelectorAll('th .sort-indicator').forEach(span => span.innerHTML = '');
        const th = document.querySelector(`th[onclick*="'${sortState.key}'"] .sort-indicator`);
        if (th) th.innerHTML = sortState.direction === 'asc' ? '▲' : '▼';
    }

    function exportToCSV() {
        if (filteredData.length === 0) {
          showToast("ไม่มีข้อมูลสำหรับส่งออก");
          return;
        }
        const headers = "วันที่,แผนก,กิจกรรม,ปริมาณ,หน่วย,CO2e_kg";
        const rows = filteredData.map(d => [
            d.dataDate.toISOString().split('T')[0],
            `"${d.department}"`, `"${d.activity}"`, d.value, d.unit, d.co2e.toFixed(4)
        ].join(','));
        
        const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `carbon_footprint_export_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("ส่งออกข้อมูลสำเร็จ");
    }
    
    function refreshData() {
        showToast("กำลังรีเฟรชข้อมูล...");
        fetchData();
    }
    
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

</script>
</body>
</html>
